# 2021_03_08

## 브라우저가 HTML 코드 중 `<script>`, `<link rel="stylesheet">` 태그를 만났을 때 다음 태그들을 처리하기 전까지 하는 일

1. 브라우저가 페이지를 렌더링 하려면 먼저 HTML 마크업을 파싱하여 DOM을 빌드하고, CSS도 CSSOM트리를 구성한다.
2. DOM트리와 CSSOM트리를 구성하여 렌더트리를 생성한다.
3. 렌더트리의 요소들을 배치한다.
4. 렌더트리를 순회하면서 각 노드들을 paint()를 호출해 UI를 화면에 그린다.

이러한 과정 중간에 `script`나 `link 태그`를 만나게 되면 **파서를 차단하고 해당 파일을 가져온다.** 이 파일을 가져오다 보니 HTTP 요청이 들어가고 해당 시간만큼 렌더링이 늦어진다.

**JS와 CSS는 렌더링 차단 리소스이다. **
- Script는 parse를 블로킹하고, stylesheet는 렌더링을 블록한다.
- Script의 경우 src가 있을 경우 외부, 없으면 inline으로 볼수 있다.
	- inline Script의 경우 안에 있는 자바스크립트를 해석하고 실행한다. 자바스크립트는 싱글쓰레드라 해석, 실행하는 동안 브라우저는 아무것도 할 수 없게 된다.

참조
- https://developers.google.com/web/fundamentals/performance/critical-rendering-path/adding-interactivity-with-javascript
- https://yceffort.kr/2020/07/critical-rendering-path

## `<script>`가 `<head>`에 들어가면 왜 안좋을까?

전통적으로 head 요소안에 쓰는것이 일반적이는데, 그 이유는 CSS파일이나 자바스크립트 파일 같은 외부 파일에 대한 참조를 한곳에서 관리하려는 것이 주요 목적이었다.

하지만 JS 파일을 전부 head요소에 넣게 되면 자바스크립트 코드를 전부 내려 받고, 파싱하고, 해석을 끝낼 때까지 페이지 렌더링이 멈추게 된다. 만약 head요소에서 스크립트를 모두 불러오게 되면 눈에 뛸 정도로 페이지 렌더링이 지연되며, 이 시간 동안 브라우저에는 텅 빈 화면만 존재하게 된다. 그래서 최신 웹 애플리케이션에서는 일반적으로 스크립트 코드를 모두 body요소 안, 페이지 콘텐츠 마지막에 쓴다.

head에 넣는 경우 DOM을 그리기전에 DOM을 컨트롤 하는 경우가 발생해서 에러가 발생 할 수도 있다. (타이밍 이슈) 이런 문제를 해결하기 위해서라도 head에 넣으면 좋지 않다.

## JS에서 defer/async attribute는 어떤 역할을 할까?

자바스크립트는 명시적으로 비동기로 선언되지 않을 경우 DOM 생성을 차단한다. defer와 async는 이러한 자바스크립트를 조금 더 유연하게 사용할 수 있도록 해준다.

- defer
	- 문서의 콘텐츠를 완전히 파싱하고 표시할 때까지 스크립트 실행을 지연해도 안점한을 뜻한다.
	- 외부 스크립트파일을 불어올때만 유효하다. 실행은 마지막에 실행되는 것이다.
	- IE7과 이전 버전에서는 인라인 스크립트에서도 이 속성을 사용할 수 있다.
	- 코드는 내려 받지만 실행은 지연시킨다고 생각하자.
	- 옜날 브라우저에서는 이 속성이 무시되기 때문에 맨 마지막에 놓는 것이 여전히 최상이다.
- async
	- HTML5에 추가된 요소.
	- 스크립트를 즉시 내려 받지만 자원을 내려받거나 다른 스크립트를 불러오는 등 다른 페이지 작업을 방해해서는 안된다고 지시한다. 다운로드가 완료되면 실행된다.
	- 외부 스크립트파일을 불러올때만 유효하다.
	- async는 순서를 보장하지 않는다. 순서를 보장하지 않기 때문에 의존성이 있는 JS에는 사용하면 안된다.

참조
- 프론트엔드 개발자를 위한 자바스크립트 프로그래밍

## `<link rel="stylesheet">`에 media attribute를 넣는게 왜 좋을까?

만약 media attribute를 넣지 않는 다면 모든 경우에 적용된다, 하지만 media attribute를 사용하게 된다면 특정 환경에서만 CSS가 적용될수 있다. 만약 특정환경에서만 동작하도록 media쿼리를 작성한다면 해당 환경에서만 CSS를 다운로드 받아서 진행하고, 해당 환경이 아닐 경우 렌더링이 차단되는 것을 막을 수 있는 것이다. **즉 필요할때만 CSS를 다운로드 받아서 사용할 수 있게 되는 것이다. **

렌더링 트리에 필요한 것만 일단 다운로드 받아서 적용시키고, 나머지 CSS는 백그라운드에서 다운받아 놓고, 적용되는 경우에 사용된다고 한다.

참조
- https://developers.google.com/web/fundamentals/performance/critical-rendering-path/render-blocking-css

#study #front #web